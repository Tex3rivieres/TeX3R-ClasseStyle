\NeedsTeXFormat{LaTeX2e}[2022-11-01]
\ProvidesPackage{style-tex3R-2-1}

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% FORMAT DE LA PAGE %%%
%%%%%%%%%%%%%%%%%%%%%%%%%

%#1 = couleur ; #2 = type de section
\renewcommand{\stylesections}[3]{\colorbox{#1}{\textcolor{white}{\normalfont#2\textbf{{#3}}}}}

\begin{luacode*}
  function FormatUtilisateur (PARAMETRES)

    local FORMAT = PARAMETRES.format
    local HEADER = PARAMETRES.header
    local PAGE = {}

    PAGE.enumi = [[\textbf{\arabic*.~}]]
    PAGE.enumii = [[\textbf{\alph*.~}]]
    PAGE.itemi = [[\textbullet]]
    PAGE.itemii = [[$\circ$]]

    PAGE.sectionname = [[\LARGE\bfseries\textcolor{couleursection}]]
    PAGE.subsectionname = [[\Large\bfseries\textcolor{couleursubsection}]]
    PAGE.subsubsectionname = [[\normalfont\large\bfseries\textcolor{couleursubsubsection}]]

    PAGE.sectionnumber = [[\stylesections{couleursection}{\LARGE}{~\Roman{section}~}\,]]
    PAGE.subsectionnumber = [[\stylesections{couleursubsection}{\LARGE}{\Alph{subsection}}\,]]
    PAGE.subsubsectionnumber = [[\stylesections{couleursubsubsection}{\LARGE}{\arabic{subsubsection}}\,]]

    PAGE.sectionsformat = [[#3 \underLine{#4}\par\vspace{0.5em}]]
    PAGE.partformat = ''

    if FORMAT == "fiche" then

      PAGE.width = '21cm'
      PAGE.height = '29.7cm'
      PAGE.parindent = '0pt'
      PAGE.parskip = '0pt'

      if HEADER == true then
        PAGE.top = '1cm'
        PAGE.bottom = '1cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '1cm'
        PAGE.headsep = '0.5cm'
        PAGE.footskip = '0cm'
      else
        PAGE.top = '1cm'
        PAGE.bottom = '1cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '0cm'
        PAGE.headsep = '0cm'
        PAGE.footskip = '0cm'
      end

    elseif FORMAT == "diapo" then

      PAGE.width = '28.8cm'
      PAGE.height = '18cm'
      PAGE.parindent = '0pt'
      PAGE.parskip = '0pt'

      if HEADER == true then
        PAGE.top = '0.5cm'
        PAGE.bottom = '3cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '1.5cm'
        PAGE.headsep = '0.5cm'
        PAGE.footskip = '0cm'
      else
      --Marges du format 'diapo'
        PAGE.top = '0.5cm'
        PAGE.bottom = '3cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '0cm'
        PAGE.headsep = '0cm'
        PAGE.footskip = '0cm'
      end

    end
    return PAGE
  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% FORMATAGES DIVERS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode}
  function PoliceUtilisateur()

    local POLICE = {}

    POLICE.taillefiche = '12pt'
    POLICE.taillediapo = '20pt'
    POLICE.texte = 'Calibri'
    POLICE.math = 'STIX Two Math'
    POLICE.mathcal = 'Libertinus Math Regular'

    return POLICE
  end
\end{luacode}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% DÉFINITION DES COULEURS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode}
  function CouleursUtilisateur(PARAMETRES)
    local PRINT = PARAMETRES.print
    local COULEURS = {}

    if PRINT then
      COULEURS.ligne = 'black'
      COULEURS.interligne = 'black!30'
      COULEURS.section = 'black'
      COULEURS.subsection = 'black!70'
      COULEURS.subsubsection = 'black!40'
      COULEURS.carreau = 'black!30'
      COULEURS.surlignelignea = 'black!20'
      COULEURS.surligneligneb = 'white'
      COULEURS.boitecours = 'white'
      COULEURS.background = 'white'

      COULEURS.application = 'black'
      COULEURS.definition = 'black'
      COULEURS.convention = 'black'
      COULEURS.exercice = 'black'
      COULEURS.exemple = 'black'
      COULEURS.methode = 'black'
      COULEURS.preuve = 'black'
      COULEURS.propriete = 'black'
      COULEURS.remarque = 'black'
      COULEURS.enonce = 'black'
      COULEURS.correction = 'black'
      COULEURS.surligne = 'black!5'



    else
      COULEURS.ligne = 'SlateBlue'
      COULEURS.interligne = 'LightSteelBlue'
      COULEURS.section = 'black'
      COULEURS.subsection = 'Red'
      COULEURS.subsubsection = 'Green'
      COULEURS.carreau = 'blue!25'
      COULEURS.surlignelignea = 'blue!20'
      COULEURS.surligneligneb = 'yellow!20'
      COULEURS.boitecours = 'black!5'
      COULEURS.background = 'white'

      COULEURS.application = 'black'
      COULEURS.definition = 'Green'
      COULEURS.convention = 'black'
      COULEURS.exercice = 'Blue'
      COULEURS.exemple = 'Blue'
      COULEURS.methode = 'black'
      COULEURS.preuve = 'black'
      COULEURS.propriete = 'Red'
      COULEURS.remarque = 'black'
      COULEURS.enonce = 'black'
      COULEURS.correction = 'Green'
      COULEURS.surligne = 'yellow!100'
    end
    return COULEURS
  end 
\end{luacode}

%%%%%%%%%%%%%%%%%%%%%%%
%%% CHOIX DES LOGOS %%%
%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode*}
  function LogosUtilisateur()

    local LOGOS = {}

    LOGOS.activite = [[\reflectbox{\faPencil*}]]
    LOGOS.basique = ''
    LOGOS.bilan = [[\faEdit[regular]\hspace{0pt}]]
    LOGOS.corrige = [[\faEdit[regular]\hspace{0pt}]]
    LOGOS.cours = [[\faBook]]
    LOGOS.DM = [[\faHome]]
    LOGOS.DS = [[\faFile*[regular]\hspace{0pt}]]
    LOGOS.flash = [[\faUserSecret]]
    LOGOS.interro = [[\faFile*[regular]\hspace{0pt}]]
    LOGOS.TD = [[\faEdit[regular]\hspace{0pt}]]

    return LOGOS
  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% REDÉFINITION DES TITRES %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode*}
  function StylesTitresUtilisateur(PARAMETRES)

    local STYLESTITRES = {}
    local FORMAT = PARAMETRES.format

    STYLESTITRES.espacement = '0.5cm'
    STYLESTITRES.titre = [[{\bfseries\LARGE\logoactif~ \underLine{#1}\par}]]
    STYLESTITRES['sans'] = [[\titre{#1}]]
    STYLESTITRES['un'] = [[\titre{#1\hfill\mdseries\large\contenuniveau$^\text{ème}$}]]
    STYLESTITRES['deux'] = [[\titre{#1~\mdseries|~\contenuchapitre\hfill\large\contenuniveau$^\text{ème}$}]]
    STYLESTITRES['trois'] = [[\titre{#1~\mdseries|~{\large\mdseries NOM :} \hfill {\large\mdseries Prénom :} \hfill \mdseries\large\contenuniveau$^\text{ème}$}]]

    if FORMAT == "fiche" then    

    STYLESTITRES.activite = STYLESTITRES['un']
    STYLESTITRES.basique = STYLESTITRES['sans']
    STYLESTITRES.bilan = STYLESTITRES['un']
    STYLESTITRES.corrige = STYLESTITRES['deux']
    STYLESTITRES.cours = STYLESTITRES['deux']
    STYLESTITRES.DM = STYLESTITRES['trois']
    STYLESTITRES.DS = STYLESTITRES['trois']
    STYLESTITRES.flash = STYLESTITRES['un']
    STYLESTITRES.interro = STYLESTITRES['trois']
    STYLESTITRES.TD = STYLESTITRES['deux']

    elseif FORMAT == "diapo" then

    STYLESTITRES.activite = STYLESTITRES['un']
    STYLESTITRES.basique = STYLESTITRES['sans']
    STYLESTITRES.bilan = STYLESTITRES['un']
    STYLESTITRES.corrige = STYLESTITRES['deux']
    STYLESTITRES.cours = STYLESTITRES['deux']
    STYLESTITRES.DM = STYLESTITRES['trois']
    STYLESTITRES.DS = STYLESTITRES['trois']
    STYLESTITRES.flash = STYLESTITRES['un']
    STYLESTITRES.interro = STYLESTITRES['trois']
    STYLESTITRES.TD = STYLESTITRES['deux']

    end

    return STYLESTITRES
  end

  function TitresUtilisateur(PARAMETRES)

    local FORMAT = PARAMETRES.format
    local TYPE = PARAMETRES.type
    local TITRE = nil

    if TYPE == "activite" then
      TITRE = [[Activité]]
    elseif TYPE == "basique" then
      TITRE = [[ ]]
    elseif TYPE == "bilan" then
      TITRE = [[Bilan]]
    elseif TYPE == "corrige" then
      TITRE = [[Corrigé]]
    elseif TYPE == "cours" then
      TITRE = [[Chapitre~\thepart]]
    elseif TYPE == "DM" then
      TITRE = [[DM n°\stepcounter{compteurDM}\thecompteurDM]]
    elseif TYPE == "DS" then
      TITRE = [[DS n°\stepcounter{compteurDS}\thecompteurDS]]
    elseif TYPE == "flash" then
      TITRE = [[Questions Flash n°\stepcounter{compteurflash}\thecompteurflash]]
    elseif TYPE == "interro" then
      TITRE = [[Interrogation n°\stepcounter{compteurinterro}\thecompteurinterro]]
    elseif TYPE == "TD" then
      TITRE = [[TD]]
    end
    tex.sprint([[\renewcommand{\titreactif}{\styleactif{]] .. TITRE .. '}}')

  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% ENVIRONNEMENTS DE COURS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \begin{luacode*}
  
% function EnvironnementsUtilisateur()

%   tex.sprint([[
  
  \renewcommand{\formatEnvCours}[3][]{
  \begin{tcolorbox}[colback=couleurboitecours, colframe=couleurbackground, boxrule=0pt, left=0.5em, top=0pt, bottom=0pt, right=0pt, enhanced, shield externalize=true, borderline west={4pt}{0pt}{#2}]
    \textcolor{#2}{\large\underLine{#1} :} \par\medskip 
    #3
  \end{tcolorbox}
  }
  % ]])

  % tex.sprint([[
    \RenewEnviron{application}[1][Application]{\formatEnvCours[#1]{couleurapplication}{\BODY}}
    \RenewEnviron{definition}[1][Définition]{\formatEnvCours[#1]{couleurdefinition}{\BODY}}
    \RenewEnviron{convention}[1][Convention]{\formatEnvCours[#1]{couleurconvention}{\BODY}}
    \RenewEnviron{exercice}[1][Exercice]{\formatEnvCours[#1]{couleurexercice}{\BODY}}
    \RenewEnviron{exemple}[1][Exemple]{\formatEnvCours[#1]{couleurexemple}{\BODY}}
    \RenewEnviron{methode}[1][Méthode]{\formatEnvCours[#1]{couleurmethode}{\BODY}}
    \RenewEnviron{preuve}[1][Preuve]{\formatEnvCours[#1]{couleurpreuve}{\BODY}}
    \RenewEnviron{propriete}[1][Propriété]{\formatEnvCours[#1]{couleurpropriete}{\BODY}}
    \RenewEnviron{remarque}[1][Remarque]{\formatEnvCours[#1]{couleurremarque}{\BODY}}

    \RenewEnviron{enonce}{%
    \stepcounter{compteurcorrection}
    \ifenonce
      \stepcounter{compteurenonce}\iftheme\hfill{\itshape\footnotesize\contenutheme}\par\vspace{0.2em}{\color{couleurenonce}\hrule height 2pt}\par\fi
      \colorbox{couleurenonce}{\textcolor{white}{{\normalfont\Large\textbf{\thecompteurenonce}}\ifdifficulte{~\raisebox{0.2em}{\scriptsize\contenudifficulte}}\fi}}\ifcompetence\hspace{0.3em}\textcolor{couleurenonce}{\underLine{\contenucompetence}} \fi\par%
      \medskip
      \BODY
      \ifsource\par\vspace{0.2em}{\color{couleurenonce}\hrule height 2pt}\par\vspace{0.2em}\hfill{\itshape\footnotesize\contenusource}\fi
    \fi
    }

    \RenewEnviron{correction}{%
    \ifcorrection
      \colorbox{couleurcorrection}{\textcolor{white}{\normalfont\Large\textbf{\thecompteurcorrection} | Correction}}\par%
      \medskip
      \BODY
    \fi
    }
%   ]])

%  end
% \end{luacode*}