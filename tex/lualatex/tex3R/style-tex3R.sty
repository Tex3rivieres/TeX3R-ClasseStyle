\NeedsTeXFormat{LaTeX2e}[2022-11-01]
\ProvidesPackage{style-tex3R}
%VERSION 2.0 du Package

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% FORMAT DE LA PAGE %%%
%%%%%%%%%%%%%%%%%%%%%%%%%

%#1 = couleur ; #2 = type de section
\renewcommand{\stylesections}[3]{\colorbox{#1}{\textcolor{white}{\normalfont#2\textbf{{#3}}}}}

\begin{luacode*}
  function FormatUtilisateur()

    local FORMAT = PARAMETRES.format
    local HEADER = PARAMETRES.header
    local PREMIER = PARAMETRES.premier

    if PREMIER then

      PAGE.enumi = [[ \textbf{\arabic*.~} ]]
      PAGE.enumii = [[ \textbf{\alph*.~} ]]
      PAGE.itemi = [[ \textbullet ]]
      PAGE.itemii = [[ $\circ$ ]]

      PAGE.sectionname = [[ \LARGE\bfseries\textcolor{couleursection} ]]
      PAGE.subsectionname = [[ \Large\bfseries\textcolor{couleursubsection} ]]
      PAGE.subsubsectionname = [[ \normalfont\large\bfseries\textcolor{couleursubsubsection} ]]

      PAGE.sectionnumber = [[ \stylesections{couleursection}{\LARGE}{~\Roman{section}~}\, ]]
      PAGE.subsectionnumber = [[ \stylesections{couleursubsection}{\LARGE}{\Alph{subsection}}\, ]]
      PAGE.subsubsectionnumber = [[ \stylesections{couleursubsubsection}{\LARGE}{\arabic{subsubsection}}\, ]]

      PAGE.sectionsformat = [[ #3 \underLine{#4}\par\vspace{0.5em} ]]
      PAGE.chapitrenormalformat = [[ \huge\bfseries Chapitre \thepart ]]
      PAGE.chapitreetoileformat = [[]]
      PAGE.partformat = [[
        \newpage
        \hfill
        \vfill
        \begin{tcolorbox}[
          colframe = black, 
          colback=white,
          coltitle=white,
          sharp corners,
          valign=center,
          top=2cm,
          bottom=2cm,
          left=0.5cm,
          enhanced,
          before skip=0cm,
        ]
        \formatchapitre
        \tcblower
        {\huge\bfseries #3}
        \end{tcolorbox}
        \hfill
        \vfill
      ]]
    end

    if FORMAT == "fiche" then

      if PREMIER then

        PAGE.width = '21cm'
        PAGE.height = '29.7cm'
        PAGE.parindent = '0pt'
        PAGE.parskip = '0pt'

      end

      -- if HEADER == true then
        PAGE.headertop = '1cm'
        PAGE.headerbottom = '0.5cm'
        PAGE.headerright = '1cm'
        PAGE.headerleft = '1cm'
        PAGE.headermarginparsep = '0cm'
        PAGE.headermarginparwidth = '0cm'
        PAGE.headerheadheight = '1cm'
        PAGE.headerheadsep = '0.5cm'
        PAGE.headerfootskip = '0.5cm'
      -- else
        PAGE.top = '1cm'
        PAGE.bottom = '0.5cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '0cm'
        PAGE.headsep = '0cm'
        PAGE.footskip = '0.5cm'
      -- end

    elseif FORMAT == "diapo" then

      if PREMIER then

        PAGE.width = '28.8cm'
        PAGE.height = '18cm'
        PAGE.parindent = '0pt'
        PAGE.parskip = '0pt'

      end

      -- if HEADER == true then
        PAGE.headertop = '0.5cm'
        PAGE.headerbottom = '2cm'
        PAGE.headerright = '1cm'
        PAGE.headerleft = '1cm'
        PAGE.headermarginparsep = '0cm'
        PAGE.headermarginparwidth = '0cm'
        PAGE.headerheadheight = '1.5cm'
        PAGE.headerheadsep = '0.5cm'
        PAGE.headerfootskip = '1cm'
      -- else
        PAGE.top = '0.5cm'
        PAGE.bottom = '2cm'
        PAGE.right = '1cm'
        PAGE.left = '1cm'
        PAGE.marginparsep = '0cm'
        PAGE.marginparwidth = '0cm'
        PAGE.headheight = '0cm'
        PAGE.headsep = '0cm'
        PAGE.footskip = '1cm'
      -- end

    end

  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%
%%% FORMATAGES DIVERS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode*}
  function PoliceUtilisateur()

    local PREMIER = PARAMETRES.premier

    if PREMIER then

      POLICE.taillefiche = '12pt'
      POLICE.taillediapo = '20pt'
      POLICE.texte = 'Calibri'
      POLICE.math = 'STIX Two Math'
      POLICE.mathcal = 'Libertinus Math Regular'
      POLICE.important = [[ \hl{#1} ]]

    end
  end
\end{luacode*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% DÉFINITION DES COULEURS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode}
  function CouleursUtilisateur()
    local PRINT = PARAMETRES.print
    local PREMIER = PARAMETRES.premier

      if PRINT then
        COULEURS.ligne = 'black'
        COULEURS.interligne = 'black!30'
        COULEURS.section = 'black'
        COULEURS.subsection = 'black!70'
        COULEURS.subsubsection = 'black!40'
        COULEURS.carreau = 'black!30'
        COULEURS.surlignelignea = 'black!20'
        COULEURS.surligneligneb = 'white'
        COULEURS.boitecours = 'white'
        COULEURS.background = 'white'

        COULEURS.application = 'black'
        COULEURS.definition = 'black'
        COULEURS.convention = 'black'
        COULEURS.exercice = 'black'
        COULEURS.exemple = 'black'
        COULEURS.methode = 'black'
        COULEURS.preuve = 'black'
        COULEURS.propriete = 'black'
        COULEURS.remarque = 'black'
        COULEURS.enonce = 'black'
        COULEURS.correction = 'black'
        COULEURS.surligne = 'black!5'
        COULEURS.surlignevisible = 'black!10'

        COULEURS.rouge = 'black'
        COULEURS.bleu = 'black'
        COULEURS.vert = 'black'

      else
        COULEURS.ligne = 'SlateBlue'
        COULEURS.interligne = 'LightSteelBlue'
        COULEURS.section = 'black'
        COULEURS.subsection = 'Red'
        COULEURS.subsubsection = 'Green'
        COULEURS.carreau = 'blue!25'
        COULEURS.surlignelignea = 'blue!20'
        COULEURS.surligneligneb = 'yellow!20'
        COULEURS.boitecours = 'black!5'
        COULEURS.background = 'white'

        COULEURS.application = 'black'
        COULEURS.definition = 'Green'
        COULEURS.convention = 'black'
        COULEURS.exercice = 'Blue'
        COULEURS.exemple = 'Blue'
        COULEURS.methode = 'black'
        COULEURS.preuve = 'black'
        COULEURS.propriete = 'Red'
        COULEURS.remarque = 'black'
        COULEURS.enonce = 'black'
        COULEURS.correction = 'black'
        COULEURS.surligne = 'yellow'
        COULEURS.surlignevisible = 'black!10'

        COULEURS.rouge = 'Red'
        COULEURS.bleu = 'Blue'
        COULEURS.vert = 'Green'
      end
  end 
\end{luacode}

%%%%%%%%%%%%%%%%%%%%%%%
%%% CHOIX DES LOGOS %%%
%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode*}
  function LogosUtilisateur()

    local PREMIER = PARAMETRES.premier

    if PREMIER then

      LOGOS.activite = [[ \reflectbox{\faPencil*} ]]
      LOGOS.basique = ''
      LOGOS.bilan = [[ \faEdit[regular] ]]
      LOGOS.corrige = [[ \faEdit[regular] ]]
      LOGOS.cours = [[ \faBook ]]
      LOGOS.DM = [[ \faHome ]]
      LOGOS.DS = [[ \faFile*[regular] ]]
      LOGOS.flash = [[ \faUserSecret ]]
      LOGOS.interro = [[ \faFile*[regular] ]]
      LOGOS.TD = [[ \faEdit[regular] ]]

    end

  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% REDÉFINITION DES TITRES %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{luacode*}
  function StylesTitresUtilisateur()

    local FORMAT = PARAMETRES.format
    local PREMIER = PARAMETRES.premier

    if PREMIER then

      STYLESTITRES.espacement = '0.5cm'
      STYLESTITRES.titre = [[ {\bfseries\LARGE\logoactif~\underLine{#1}\par} ]]
      STYLESTITRES['sans'] = [[  ]]
      STYLESTITRES['un'] = [[ \titre{#1\hfill\mdseries\large\contenuniveau} ]]
      STYLESTITRES['deux'] = [[ \titre{#1~\mdseries|~\contenuchapitre\hfill\large\contenuniveau} ]]
      STYLESTITRES['trois'] = [[ \titre{#1~\mdseries|~{\large\mdseries NOM :} \hfill {\large\mdseries Prénom :} \hfill \mdseries\large\contenuniveau} ]]

      if FORMAT == "fiche" then    

      STYLESTITRES.activite = STYLESTITRES['un']
      STYLESTITRES.basique = STYLESTITRES['sans']
      STYLESTITRES.bilan = STYLESTITRES['un']
      STYLESTITRES.corrige = STYLESTITRES['deux']
      STYLESTITRES.cours = STYLESTITRES['deux']
      STYLESTITRES.DM = STYLESTITRES['trois']
      STYLESTITRES.DS = STYLESTITRES['trois']
      STYLESTITRES.flash = STYLESTITRES['un']
      STYLESTITRES.interro = STYLESTITRES['trois']
      STYLESTITRES.TD = STYLESTITRES['deux']

      elseif FORMAT == "diapo" then

      STYLESTITRES.activite = STYLESTITRES['un']
      STYLESTITRES.basique = STYLESTITRES['sans']
      STYLESTITRES.bilan = STYLESTITRES['un']
      STYLESTITRES.corrige = STYLESTITRES['deux']
      STYLESTITRES.cours = STYLESTITRES['deux']
      STYLESTITRES.DM = STYLESTITRES['trois']
      STYLESTITRES.DS = STYLESTITRES['trois']
      STYLESTITRES.flash = STYLESTITRES['un']
      STYLESTITRES.interro = STYLESTITRES['trois']
      STYLESTITRES.TD = STYLESTITRES['deux']

      end

    end

  end

  function TitresUtilisateur()

    local FORMAT = PARAMETRES.format
    local TYPE = PARAMETRES.type
    local PREMIER = PARAMETRES.premier

    if TYPE == "activite" then
      TITRES.format = [[ Activité ]]
    elseif TYPE == "basique" then
      TITRES.format = [[ ]]
    elseif TYPE == "bilan" then
      TITRES.format = [[ Bilan ]]
    elseif TYPE == "corrige" then
      TITRES.format = [[ Corrigé ]]
    elseif TYPE == "cours" then
      TITRES.format = [[ Chapitre~\thepart ]]
    elseif TYPE == "DM" then
      TITRES.format = [[ DM n°\stepcounter{compteurDM}\thecompteurDM ]]
    elseif TYPE == "DS" then
      TITRES.format = [[ DS n°\stepcounter{compteurDS}\thecompteurDS ]]
    elseif TYPE == "flash" then
      TITRES.format = [[ Questions Flash n°\stepcounter{compteurflash}\thecompteurflash ]]
    elseif TYPE == "interro" then
      TITRES.format = [[ Interrogation n°\stepcounter{compteurinterro}\thecompteurinterro ]]
    elseif TYPE == "TD" then
      TITRES.format = [[ TD ]]
    end

    if PREMIER then

      TITRES.tocactivite = 'Activité'
      TITRES.tocbasique = 'Sans titre'
      TITRES.tocbilan = 'Bilan'
      TITRES.toccorrige = 'Corrigé'
      TITRES.toccours = 'Cours'
      TITRES.tocDM = 'DM'
      TITRES.tocDS = 'DS'
      TITRES.tocflash = 'Flash'
      TITRES.tocinterro = 'Interrogation'
      TITRES.tocTD = 'TD'

    end

  end
\end{luacode*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% ENVIRONNEMENTS DE COURS %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  
\begin{luacode*}
function EnvironnementsUtilisateur()

  local PREMIER = PARAMETRES.premier
  --#1 = nom modifiable (optionnel) ; #2 = couleur

  if PREMIER then
    ENVIRONNEMENTS.formatcours = [[
      \begin{tcolorbox}[
        colback=couleurboitecours, 
        colframe=couleurbackground, 
        boxrule=0pt, 
        left=0.5em, 
        top=0pt, 
        bottom=0pt, 
        right=0pt, 
        enhanced, 
        shield externalize=true, 
        borderline west={4pt}{0pt}{#2}
        ]
        \textcolor{#2}{\large\underLine{#1} :}\par
        \medskip 
        \BODY 
      \end{tcolorbox}
      ]]

    ENVIRONNEMENTS.enonce = [[
      \iftheme
        \hfill{\itshape\footnotesize\contenutheme}\par\vspace{0.2em}{\color{couleurenonce}\hrule height 2pt}\par
      \fi
      \colorbox{couleurenonce}{\textcolor{white}{
        {
        \Large\textbf{\thecompteurexercice}}
        \ifdifficulte{~\raisebox{0.2em}{\scriptsize\contenudifficulte}}\fi
        }
      }
      \ifcompetence\hspace{0.3em}\textcolor{couleurenonce}{\underLine{\contenucompetence}}\fi\ifbareme\hfill {\bfseries/\contenubareme~points}\fi\par
        \medskip
        \BODY
        \ifsource\par
          \vspace{0.2em}{\color{couleurenonce}\hrule height 2pt}\par\vspace{0.2em}\hfill{\itshape\footnotesize\contenusource}
        \fi
    ]]

    ENVIRONNEMENTS.correction = [[
      \colorbox{couleurcorrection}{\textcolor{white}{
        \normalfont\Large\textbf{\thecompteurexercice} | Correction}
      }\par
      \medskip
      \BODY
    ]]

    ENVIRONNEMENTS.tocexercice = 'Exercice'
    ENVIRONNEMENTS.tocenonce = 'Énoncé'
    ENVIRONNEMENTS.toccorrection = 'Correction'
  end
end
\end{luacode*}

\begin{luacode*}
  function mesParametres(str)

    if str == 'activite' or str == 'Activite' then
      Type = 'activite'
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
    elseif str == 'basique' or str == 'Basique' then

    elseif str == 'bilan' or str == 'Bilan' then
      Type = 'bilan'
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
    elseif str == 'corrige' or str == 'Corrige' then

    elseif str == 'cours' or str == 'Cours' then
      Type = 'cours'
      Enonce = true
      Correction = true
      Stretch = false
    elseif str == 'DM' then
      Type = 'DM'
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
    elseif str == 'DS' then
      Type = 'DS'
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
      Bareme = true
    elseif str == 'flash' or str == 'Flash' then

    elseif str == 'interro' or str == 'Interro' then
      Type = 'interro'
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
      Bareme = true
    elseif str == 'TD' then
      Type = 'TD'
      Header = true
      Impression = true
      Competence = true
      Enonce = true
      Stretch = true
    end
  end

  function NiveauUtilisateur(arg)
    local str = nil
    if arg == '6' then
      str = '6$^\\text{ème}$'
    elseif arg == '5' then
      str = '5$^\\text{ème}$'
    elseif arg == '4' then
      str = '4$^\\text{ème}$'
    elseif arg == '3' then
      str = '3$^\\text{ème}$'
    end
    NiveauDocument(str) 
  end
\end{luacode*}

\parametrage
\mygeometry